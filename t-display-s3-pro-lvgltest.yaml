esphome:
  name: t-display-s3-pro-lvgltest
  friendly_name: "T-Display S3 Pro Power Monitor"
  platformio_options:
    build_flags: ["-DLV_USE_CHART=1"]
    build_unflags: ["-Werror=all"]
    board_build.flash_mode: dio
  on_boot:
    priority: 100 
    then:
      - switch.turn_on: display_power
      - light.turn_on: { id: display_backlight, brightness: 100% }
      - delay: 1s
      - script.execute: setup_chart

esp32:
  board: esp32-s3-devkitc-1
  variant: esp32s3
  framework: { type: esp-idf }

# ==============================================================================
# BUS CONFIGURATION
# ==============================================================================
spi:
  clk_pin: 18
  mosi_pin: 17
  miso_pin: 16 

i2c:
  sda: 10
  scl: 11
  scan: true

# ==============================================================================
# HARDWARE CONFIGURATION
# ==============================================================================
output:
  - platform: ledc
    pin: 48
    id: backlight_pwm

light:
  - platform: monochromatic
    output: backlight_pwm
    id: display_backlight
    restore_mode: RESTORE_DEFAULT_ON

switch:
  - platform: gpio
    pin: 15
    id: display_power
    restore_mode: ALWAYS_ON

display:
  - platform: mipi_spi
    id: my_display
    model: t-display-s3-pro
    cs_pin: 39
    dc_pin: 9
    rotation: 90Â°
    dimensions: { width: 480, height: 222 }

touchscreen:
  - platform: cst226
    interrupt_pin: 21 
    reset_pin: 13
    display: my_display

# ==============================================================================
# ASSETS
# ==============================================================================
font:
  - file: 'fonts/BebasNeue-Regular.ttf'
    id: font_bebas_80
    size: 80
  - file: 'fonts/arial.ttf'
    id: font_arial_20
    size: 20

# ==============================================================================
# GLOBALS & CHART POINTERS
# ==============================================================================
globals:
  - { id: my_chart, type: lv_obj_t*, initial_value: 'nullptr' }
  - { id: ser_cons, type: lv_chart_series_t*, initial_value: 'nullptr' }
  - { id: ser_prod, type: lv_chart_series_t*, initial_value: 'nullptr' }
  - { id: ser_solar, type: lv_chart_series_t*, initial_value: 'nullptr' }

# ==============================================================================
# LVGL UI DEFINITION
# ==============================================================================
lvgl:
  log_level: DEBUG
  pages:
    - id: page1
      bg_color: 0x000000
      on_focus:
        - lambda: 'if(id(my_chart)) lv_obj_add_flag(id(my_chart), LV_OBJ_FLAG_HIDDEN);'
      widgets:
        - obj: &header_bar
            width: 100%
            height: 40
            bg_color: 0x2828FF
            align: TOP_MID
            widgets:
              - label: { id: time_p1, text: "---", align: CENTER, text_font: font_arial_20 }
              - label: { id: vcc_p1, text: "---", align: RIGHT_MID, x: -10, text_font: font_arial_20 }
        - obj: &center_container
            width: 100%
            height: 180
            y: 40
            bg_opa: 0
            layout: { type: FLEX, flex_flow: COLUMN, flex_align_main: CENTER, flex_align_cross: CENTER }
            widgets:
              - label: { id: main_pwr_p1, text: "--- W", text_font: font_bebas_80 }

    - id: page2
      bg_color: 0x000000
      on_focus:
        - lambda: 'if(id(my_chart)) lv_obj_clear_flag(id(my_chart), LV_OBJ_FLAG_HIDDEN);'
      widgets:
        - obj: { <<: *header_bar, widgets: [ 
            { label: { id: time_p2, text: "---", align: CENTER, text_font: font_arial_20 } },
            { label: { id: vcc_p2, text: "---", align: RIGHT_MID, x: -10, text_font: font_arial_20 } } 
          ] }
        - obj: { <<: *center_container, height: 80, widgets: [ 
            { label: { id: main_pwr_p2, text: "--- W", text_font: font_bebas_80 } }
          ] }

    - id: page3
      bg_color: 0x000000
      on_focus:
        - lambda: 'if(id(my_chart)) lv_obj_clear_flag(id(my_chart), LV_OBJ_FLAG_HIDDEN);'
      widgets:
        - obj: { <<: *header_bar, widgets: [ 
            { label: { id: time_p3, text: "---", align: CENTER, text_font: font_arial_20 } },
            { label: { id: vcc_p3, text: "---", align: RIGHT_MID, x: -10, text_font: font_arial_20 } } 
          ] }
        - obj: { <<: *center_container, height: 80, widgets: [ 
            { label: { id: solar_pwr_p3, text: "--- W", text_font: font_bebas_80 } }
          ] }

# ==============================================================================
# LOGIC & DATA
# ==============================================================================
script:
  - id: setup_chart
    then:
      - lambda: |-
          if (id(my_chart) == nullptr) {
            id(my_chart) = lv_chart_create(lv_layer_top());
            lv_obj_set_size(id(my_chart), 460, 100);
            lv_obj_align(id(my_chart), LV_ALIGN_BOTTOM_MID, 0, -5);
            
            lv_chart_set_type(id(my_chart), LV_CHART_TYPE_LINE);
            lv_chart_set_point_count(id(my_chart), 60);
            lv_chart_set_range(id(my_chart), LV_CHART_AXIS_PRIMARY_Y, 0, 5000); 
            
            lv_obj_set_style_bg_opa(id(my_chart), 40, 0);
            lv_obj_set_style_bg_color(id(my_chart), lv_color_hex(0x111111), 0);
            lv_obj_set_style_border_width(id(my_chart), 1, 0);
            lv_obj_set_style_border_color(id(my_chart), lv_color_hex(0x444444), 0);
            lv_chart_set_div_line_count(id(my_chart), 3, 5);
            
            id(ser_cons) = lv_chart_add_series(id(my_chart), lv_color_hex(0xFF0000), LV_CHART_AXIS_PRIMARY_Y);
            id(ser_prod) = lv_chart_add_series(id(my_chart), lv_color_hex(0x00FF00), LV_CHART_AXIS_PRIMARY_Y);
            id(ser_solar) = lv_chart_add_series(id(my_chart), lv_color_hex(0xFF9900), LV_CHART_AXIS_PRIMARY_Y);
            
            lv_obj_set_style_line_width(id(my_chart), 2, LV_PART_ITEMS);
            lv_obj_add_flag(id(my_chart), LV_OBJ_FLAG_HIDDEN);
          }

time:
  - platform: homeassistant
    id: esptime
    on_time:
      - seconds: 0
        then:
          - lvgl.label.update: { id: time_p1, text: !lambda 'return id(esptime).now().strftime("%H:%M");' }
          - lvgl.label.update: { id: time_p2, text: !lambda 'return id(esptime).now().strftime("%H:%M");' }
          - lvgl.label.update: { id: time_p3, text: !lambda 'return id(esptime).now().strftime("%H:%M");' }

sensor:
  - platform: adc
    pin: GPIO04
    id: vcc
    update_interval: 60s
    on_value:
      - lvgl.label.update: { id: vcc_p1, text: !lambda 'return str_sprintf("%.2fV", x * 2.0);' }
      - lvgl.label.update: { id: vcc_p2, text: !lambda 'return str_sprintf("%.2fV", x * 2.0);' }
      - lvgl.label.update: { id: vcc_p3, text: !lambda 'return str_sprintf("%.2fV", x * 2.0);' }

  - platform: homeassistant
    id: main_power
    entity_id: sensor.main_power # Update this to your correct entity ID if needed
    on_value:
      - lvgl.label.update: { id: main_pwr_p1, text: !lambda 'return str_sprintf("%.0f W", x);' }
      - lvgl.label.update: { id: main_pwr_p2, text: !lambda 'return str_sprintf("%.0f W", x);' }
      - lambda: |-
          if(id(my_chart)) {
            if (x >= 0) {
              if(id(ser_cons)) lv_chart_set_next_value(id(my_chart), id(ser_cons), (int32_t)x);
              if(id(ser_prod)) lv_chart_set_next_value(id(my_chart), id(ser_prod), 0);
            } else {
              if(id(ser_cons)) lv_chart_set_next_value(id(my_chart), id(ser_cons), 0);
              if(id(ser_prod)) lv_chart_set_next_value(id(my_chart), id(ser_prod), (int32_t)abs(x));
            }
            lv_obj_invalidate(id(my_chart));
          }

  - platform: homeassistant
    id: solar_power
    entity_id: sensor.dds238_2_solar_energy_power
    on_value:
      - lvgl.label.update: { id: solar_pwr_p3, text: !lambda 'return str_sprintf("%.0f W", x);' }
      - lambda: |-
          if(id(my_chart) && id(ser_solar)) {
            lv_chart_set_next_value(id(my_chart), id(ser_solar), (int32_t)x);
            lv_obj_invalidate(id(my_chart));
          }

binary_sensor:
  - platform: gpio
    pin: { number: GPIO00, inverted: true, mode: INPUT_PULLUP }
    id: button_next_page
    on_press:
      - lvgl.page.next:

api: { encryption: { key: !secret api_secret } }
ota: [{ platform: esphome }]
wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
logger: { level: DEBUG }